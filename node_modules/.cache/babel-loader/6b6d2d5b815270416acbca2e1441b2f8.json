{"ast":null,"code":"import _classCallCheck from\"/home/runner/work/watchparty/watchparty/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"/home/runner/work/watchparty/watchparty/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _inherits from\"/home/runner/work/watchparty/watchparty/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"/home/runner/work/watchparty/watchparty/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import React from'react';import{Button,Comment,Icon,Input,Popup}from'semantic-ui-react';import'emoji-mart/css/emoji-mart.css';import{Picker}from'emoji-mart';import onClickOutside from'react-onclickoutside';//@ts-ignore\nimport Linkify from'react-linkify';import{SecureLink}from'react-secure-link';import{formatTimestamp,getColorForStringHex,getDefaultPicture}from'../../utils';import{Separator}from'../App/App';import{UserMenu}from'../UserMenu/UserMenu';import classes from'./Chat.module.css';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";export var Chat=/*#__PURE__*/function(_React$Component){_inherits(Chat,_React$Component);var _super=_createSuper(Chat);function Chat(){var _this;_classCallCheck(this,Chat);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this.state={chatMsg:'',isNearBottom:true,isPickerOpen:false};_this.messagesRef=/*#__PURE__*/React.createRef();_this.updateChatMsg=function(_e,data){// console.log(e.target.selectionStart);\n_this.setState({chatMsg:data.value});};_this.sendChatMsg=function(){if(!_this.state.chatMsg){return;}if(_this.chatTooLong()){return;}_this.setState({chatMsg:''});_this.props.socket.emit('CMD:chat',_this.state.chatMsg);};_this.chatTooLong=function(){var _this$state$chatMsg;return Boolean(((_this$state$chatMsg=_this.state.chatMsg)===null||_this$state$chatMsg===void 0?void 0:_this$state$chatMsg.length)>10000);};_this.onScroll=function(){_this.setState({isNearBottom:_this.isChatNearBottom()});};_this.isChatNearBottom=function(){return _this.messagesRef.current&&_this.messagesRef.current.scrollHeight-_this.messagesRef.current.scrollTop-_this.messagesRef.current.offsetHeight<100;};_this.scrollToBottom=function(){if(_this.messagesRef.current){_this.messagesRef.current.scrollTop=_this.messagesRef.current.scrollHeight;}};_this.formatMessage=function(cmd,msg){if(cmd==='host'){return/*#__PURE__*/_jsxs(React.Fragment,{children:[\"changed the video to \",/*#__PURE__*/_jsx(\"span\",{style:{textTransform:'initial'},children:_this.props.getMediaDisplayName(msg)})]});}else if(cmd==='playlistAdd'){return/*#__PURE__*/_jsxs(React.Fragment,{children:[\"added to the playlist: \",/*#__PURE__*/_jsx(\"span\",{style:{textTransform:'initial'},children:_this.props.getMediaDisplayName(msg)})]});}else if(cmd==='seek'){return\"jumped to \".concat(formatTimestamp(msg));}else if(cmd==='play'){return\"started the video at \".concat(formatTimestamp(msg));}else if(cmd==='pause'){return\"paused the video at \".concat(formatTimestamp(msg));}else if(cmd==='lock'){return\"locked the room\";}else if(cmd==='unlock'){return'unlocked the room';}else if(cmd==='vBrowserTimeout'){return/*#__PURE__*/_jsxs(React.Fragment,{children:[\"The VBrowser shut down automatically.\",/*#__PURE__*/_jsx(\"br\",{}),\"Subscribe for longer sessions.\"]});}else if(cmd==='vBrowserAlmostTimeout'){return/*#__PURE__*/_jsxs(React.Fragment,{children:[\"The VBrowser will shut down soon.\",/*#__PURE__*/_jsx(\"br\",{}),\"Subscribe for longer sessions.\"]});}return cmd;};_this.addEmoji=function(emoji){_this.setState({chatMsg:_this.state.chatMsg+emoji.native});};return _this;}_createClass(Chat,[{key:\"componentDidMount\",value:function componentDidMount(){var _this$messagesRef$cur;this.scrollToBottom();(_this$messagesRef$cur=this.messagesRef.current)===null||_this$messagesRef$cur===void 0?void 0:_this$messagesRef$cur.addEventListener('scroll',this.onScroll);}},{key:\"componentDidUpdate\",value:function componentDidUpdate(prevProps){if(this.props.scrollTimestamp!==prevProps.scrollTimestamp){if(prevProps.scrollTimestamp===0||this.state.isNearBottom){this.scrollToBottom();}}if(this.props.hide!==prevProps.hide){this.scrollToBottom();}}},{key:\"render\",value:function render(){var _this2=this;return/*#__PURE__*/_jsxs(\"div\",{className:this.props.className,style:{display:this.props.hide?'none':'flex',flexDirection:'column',flexGrow:1,minHeight:0,marginTop:0,marginBottom:0,padding:'8px'},children:[/*#__PURE__*/_jsxs(\"div\",{className:\"chatContainer\",ref:this.messagesRef,style:{position:'relative'},children:[/*#__PURE__*/_jsx(Comment.Group,{children:this.props.chat.map(function(msg){return/*#__PURE__*/_jsx(ChatMessage,{message:msg,pictureMap:_this2.props.pictureMap,nameMap:_this2.props.nameMap,formatMessage:_this2.formatMessage,owner:_this2.props.owner,user:_this2.props.user,socket:_this2.props.socket},msg.timestamp+msg.id);})}),!this.state.isNearBottom&&/*#__PURE__*/_jsx(Button,{size:\"tiny\",onClick:this.scrollToBottom,style:{position:'sticky',bottom:0,display:'block',margin:'0 auto'},children:\"Jump to bottom\"})]}),/*#__PURE__*/_jsx(Separator,{}),this.state.isPickerOpen&&/*#__PURE__*/_jsx(PickerMenu,{addEmoji:this.addEmoji,closeMenu:function closeMenu(){return _this2.setState({isPickerOpen:false});}}),/*#__PURE__*/_jsxs(Input,{inverted:true,fluid:true,onKeyPress:function onKeyPress(e){return e.key==='Enter'&&_this2.sendChatMsg();},onChange:this.updateChatMsg,value:this.state.chatMsg,error:this.chatTooLong(),icon:true,disabled:this.props.isChatDisabled,placeholder:this.props.isChatDisabled?'The chat was disabled by the room owner.':'Enter a message...',children:[/*#__PURE__*/_jsx(\"input\",{}),/*#__PURE__*/_jsx(Icon// style={{ right: '40px' }}\n,{onClick:function onClick(){return _this2.setState({isPickerOpen:true});},name:'',inverted:true,circular:true,link:true,disabled:this.props.isChatDisabled,style:{opacity:1},children:/*#__PURE__*/_jsx(\"span\",{role:\"img\",\"aria-label\":\"Emoji\",children:\"\\uD83D\\uDE00\"})})]})]});}}]);return Chat;}(React.Component);var ChatMessage=function ChatMessage(_ref){var message=_ref.message,nameMap=_ref.nameMap,pictureMap=_ref.pictureMap,formatMessage=_ref.formatMessage,user=_ref.user,socket=_ref.socket,owner=_ref.owner;var id=message.id,timestamp=message.timestamp,cmd=message.cmd,msg=message.msg,system=message.system,isSub=message.isSub;return/*#__PURE__*/_jsxs(Comment,{children:[id?/*#__PURE__*/_jsx(Popup,{content:\"WatchParty Plus subscriber\",disabled:!isSub,trigger:/*#__PURE__*/_jsx(Comment.Avatar,{className:isSub?classes.subscriber:'',src:pictureMap[id]||getDefaultPicture(nameMap[id],getColorForStringHex(id))})}):null,/*#__PURE__*/_jsxs(Comment.Content,{children:[/*#__PURE__*/_jsx(UserMenu,{displayName:nameMap[id]||id,user:user,timestamp:timestamp,socket:socket,userToManage:id,isChatMessage:true,disabled:!Boolean(owner&&owner===(user===null||user===void 0?void 0:user.uid)),trigger:/*#__PURE__*/_jsxs(Comment.Author,{as:\"a\",className:\"light\",children:[Boolean(system)&&'System',nameMap[id]||id]})}),/*#__PURE__*/_jsx(Comment.Metadata,{className:\"dark\",children:/*#__PURE__*/_jsx(\"div\",{children:new Date(timestamp).toLocaleTimeString()})}),/*#__PURE__*/_jsx(Comment.Text,{className:\"light system\",children:cmd&&formatMessage(cmd,msg)}),/*#__PURE__*/_jsx(Linkify,{componentDecorator:function componentDecorator(decoratedHref,decoratedText,key){return/*#__PURE__*/_jsx(SecureLink,{href:decoratedHref,children:decoratedText},key);},children:/*#__PURE__*/_jsx(Comment.Text,{className:\"light\",children:!cmd&&msg})})]})]});};var PickerMenuInner=/*#__PURE__*/function(_React$Component2){_inherits(PickerMenuInner,_React$Component2);var _super2=_createSuper(PickerMenuInner);function PickerMenuInner(){var _this3;_classCallCheck(this,PickerMenuInner);for(var _len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2];}_this3=_super2.call.apply(_super2,[this].concat(args));_this3.handleClickOutside=function(){_this3.props.closeMenu();};return _this3;}_createClass(PickerMenuInner,[{key:\"render\",value:function render(){return/*#__PURE__*/_jsx(\"div\",{style:{position:'absolute',bottom:'60px'},children:/*#__PURE__*/_jsx(Picker,{set:\"google\",sheetSize:64,theme:\"dark\",showPreview:false,showSkinTones:false,onSelect:this.props.addEmoji})});}}]);return PickerMenuInner;}(React.Component);var PickerMenu=onClickOutside(PickerMenuInner);","map":{"version":3,"sources":["/home/runner/work/watchparty/watchparty/src/components/Chat/Chat.tsx"],"names":["React","Button","Comment","Icon","Input","Popup","Picker","onClickOutside","Linkify","SecureLink","formatTimestamp","getColorForStringHex","getDefaultPicture","Separator","UserMenu","classes","Chat","state","chatMsg","isNearBottom","isPickerOpen","messagesRef","createRef","updateChatMsg","_e","data","setState","value","sendChatMsg","chatTooLong","props","socket","emit","Boolean","length","onScroll","isChatNearBottom","current","scrollHeight","scrollTop","offsetHeight","scrollToBottom","formatMessage","cmd","msg","textTransform","getMediaDisplayName","addEmoji","emoji","native","addEventListener","prevProps","scrollTimestamp","hide","className","display","flexDirection","flexGrow","minHeight","marginTop","marginBottom","padding","position","chat","map","pictureMap","nameMap","owner","user","timestamp","id","bottom","margin","e","key","isChatDisabled","opacity","Component","ChatMessage","message","system","isSub","subscriber","uid","Date","toLocaleTimeString","decoratedHref","decoratedText","PickerMenuInner","handleClickOutside","closeMenu","PickerMenu"],"mappings":"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","sourcesContent":["import React from 'react';\nimport { Button, Comment, Icon, Input, Popup } from 'semantic-ui-react';\nimport 'emoji-mart/css/emoji-mart.css';\nimport { EmojiData, Picker } from 'emoji-mart';\nimport onClickOutside from 'react-onclickoutside';\n//@ts-ignore\nimport Linkify from 'react-linkify';\nimport { SecureLink } from 'react-secure-link';\n\nimport {\n  formatTimestamp,\n  getColorForStringHex,\n  getDefaultPicture,\n} from '../../utils';\nimport { Separator } from '../App/App';\nimport { UserMenu } from '../UserMenu/UserMenu';\nimport { Socket } from 'socket.io-client';\nimport firebase from 'firebase/compat/app';\nimport classes from './Chat.module.css';\n\ninterface ChatProps {\n  chat: ChatMessage[];\n  nameMap: StringDict;\n  pictureMap: StringDict;\n  socket: Socket;\n  scrollTimestamp: number;\n  className?: string;\n  getMediaDisplayName: Function;\n  hide?: boolean;\n  isChatDisabled?: boolean;\n  user: firebase.User | undefined;\n  owner: string | undefined;\n}\n\nexport class Chat extends React.Component<ChatProps> {\n  public state = { chatMsg: '', isNearBottom: true, isPickerOpen: false };\n  messagesRef = React.createRef<HTMLDivElement>();\n\n  componentDidMount() {\n    this.scrollToBottom();\n    this.messagesRef.current?.addEventListener('scroll', this.onScroll);\n  }\n\n  componentDidUpdate(prevProps: ChatProps) {\n    if (this.props.scrollTimestamp !== prevProps.scrollTimestamp) {\n      if (prevProps.scrollTimestamp === 0 || this.state.isNearBottom) {\n        this.scrollToBottom();\n      }\n    }\n    if (this.props.hide !== prevProps.hide) {\n      this.scrollToBottom();\n    }\n  }\n\n  updateChatMsg = (_e: any, data: { value: string }) => {\n    // console.log(e.target.selectionStart);\n    this.setState({ chatMsg: data.value });\n  };\n\n  sendChatMsg = () => {\n    if (!this.state.chatMsg) {\n      return;\n    }\n    if (this.chatTooLong()) {\n      return;\n    }\n    this.setState({ chatMsg: '' });\n    this.props.socket.emit('CMD:chat', this.state.chatMsg);\n  };\n\n  chatTooLong = () => {\n    return Boolean(this.state.chatMsg?.length > 10000);\n  };\n\n  onScroll = () => {\n    this.setState({ isNearBottom: this.isChatNearBottom() });\n  };\n\n  isChatNearBottom = () => {\n    return (\n      this.messagesRef.current &&\n      this.messagesRef.current.scrollHeight -\n        this.messagesRef.current.scrollTop -\n        this.messagesRef.current.offsetHeight <\n        100\n    );\n  };\n\n  scrollToBottom = () => {\n    if (this.messagesRef.current) {\n      this.messagesRef.current.scrollTop =\n        this.messagesRef.current.scrollHeight;\n    }\n  };\n\n  formatMessage = (cmd: string, msg: string): React.ReactNode | string => {\n    if (cmd === 'host') {\n      return (\n        <React.Fragment>\n          {`changed the video to `}\n          <span style={{ textTransform: 'initial' }}>\n            {this.props.getMediaDisplayName(msg)}\n          </span>\n        </React.Fragment>\n      );\n    } else if (cmd === 'playlistAdd') {\n      return (\n        <React.Fragment>\n          {`added to the playlist: `}\n          <span style={{ textTransform: 'initial' }}>\n            {this.props.getMediaDisplayName(msg)}\n          </span>\n        </React.Fragment>\n      );\n    } else if (cmd === 'seek') {\n      return `jumped to ${formatTimestamp(msg)}`;\n    } else if (cmd === 'play') {\n      return `started the video at ${formatTimestamp(msg)}`;\n    } else if (cmd === 'pause') {\n      return `paused the video at ${formatTimestamp(msg)}`;\n    } else if (cmd === 'lock') {\n      return `locked the room`;\n    } else if (cmd === 'unlock') {\n      return 'unlocked the room';\n    } else if (cmd === 'vBrowserTimeout') {\n      return (\n        <React.Fragment>\n          The VBrowser shut down automatically.\n          <br />\n          Subscribe for longer sessions.\n        </React.Fragment>\n      );\n    } else if (cmd === 'vBrowserAlmostTimeout') {\n      return (\n        <React.Fragment>\n          The VBrowser will shut down soon.\n          <br />\n          Subscribe for longer sessions.\n        </React.Fragment>\n      );\n    }\n    return cmd;\n  };\n\n  addEmoji = (emoji: EmojiData) => {\n    this.setState({ chatMsg: this.state.chatMsg + (emoji as any).native });\n  };\n\n  render() {\n    return (\n      <div\n        className={this.props.className}\n        style={{\n          display: this.props.hide ? 'none' : 'flex',\n          flexDirection: 'column',\n          flexGrow: 1,\n          minHeight: 0,\n          marginTop: 0,\n          marginBottom: 0,\n          padding: '8px',\n        }}\n      >\n        <div\n          className=\"chatContainer\"\n          ref={this.messagesRef}\n          style={{ position: 'relative' }}\n        >\n          <Comment.Group>\n            {this.props.chat.map((msg) => (\n              <ChatMessage\n                key={msg.timestamp + msg.id}\n                message={msg}\n                pictureMap={this.props.pictureMap}\n                nameMap={this.props.nameMap}\n                formatMessage={this.formatMessage}\n                owner={this.props.owner}\n                user={this.props.user}\n                socket={this.props.socket}\n              />\n            ))}\n            {/* <div ref={this.messagesEndRef} /> */}\n          </Comment.Group>\n          {!this.state.isNearBottom && (\n            <Button\n              size=\"tiny\"\n              onClick={this.scrollToBottom}\n              style={{\n                position: 'sticky',\n                bottom: 0,\n                display: 'block',\n                margin: '0 auto',\n              }}\n            >\n              Jump to bottom\n            </Button>\n          )}\n        </div>\n        <Separator />\n        {this.state.isPickerOpen && (\n          <PickerMenu\n            addEmoji={this.addEmoji}\n            closeMenu={() => this.setState({ isPickerOpen: false })}\n          />\n        )}\n        <Input\n          inverted\n          fluid\n          onKeyPress={(e: any) => e.key === 'Enter' && this.sendChatMsg()}\n          onChange={this.updateChatMsg}\n          value={this.state.chatMsg}\n          error={this.chatTooLong()}\n          icon\n          disabled={this.props.isChatDisabled}\n          placeholder={\n            this.props.isChatDisabled\n              ? 'The chat was disabled by the room owner.'\n              : 'Enter a message...'\n          }\n        >\n          <input />\n          <Icon\n            // style={{ right: '40px' }}\n            onClick={() => this.setState({ isPickerOpen: true })}\n            name={'' as any}\n            inverted\n            circular\n            link\n            disabled={this.props.isChatDisabled}\n            style={{ opacity: 1 }}\n          >\n            <span role=\"img\" aria-label=\"Emoji\">\n              ðŸ˜€\n            </span>\n          </Icon>\n          {/* <Icon onClick={this.sendChatMsg} name=\"send\" inverted circular link /> */}\n        </Input>\n      </div>\n    );\n  }\n}\n\nconst ChatMessage = ({\n  message,\n  nameMap,\n  pictureMap,\n  formatMessage,\n  user,\n  socket,\n  owner,\n}: {\n  message: ChatMessage;\n  nameMap: StringDict;\n  pictureMap: StringDict;\n  formatMessage: (cmd: string, msg: string) => React.ReactNode;\n  user: firebase.User | undefined;\n  socket: Socket;\n  owner: string | undefined;\n}) => {\n  const { id, timestamp, cmd, msg, system, isSub } = message;\n  return (\n    <Comment>\n      {id ? (\n        <Popup\n          content=\"WatchParty Plus subscriber\"\n          disabled={!isSub}\n          trigger={\n            <Comment.Avatar\n              className={isSub ? classes.subscriber : ''}\n              src={\n                pictureMap[id] ||\n                getDefaultPicture(nameMap[id], getColorForStringHex(id))\n              }\n            />\n          }\n        />\n      ) : null}\n      <Comment.Content>\n        <UserMenu\n          displayName={nameMap[id] || id}\n          user={user}\n          timestamp={timestamp}\n          socket={socket}\n          userToManage={id}\n          isChatMessage\n          disabled={!Boolean(owner && owner === user?.uid)}\n          trigger={\n            <Comment.Author as=\"a\" className=\"light\">\n              {Boolean(system) && 'System'}\n              {nameMap[id] || id}\n            </Comment.Author>\n          }\n        />\n        <Comment.Metadata className=\"dark\">\n          <div>{new Date(timestamp).toLocaleTimeString()}</div>\n        </Comment.Metadata>\n        <Comment.Text className=\"light system\">\n          {cmd && formatMessage(cmd, msg)}\n        </Comment.Text>\n        <Linkify\n          componentDecorator={(\n            decoratedHref: string,\n            decoratedText: string,\n            key: string\n          ) => (\n            <SecureLink href={decoratedHref} key={key}>\n              {decoratedText}\n            </SecureLink>\n          )}\n        >\n          <Comment.Text className=\"light\">{!cmd && msg}</Comment.Text>\n        </Linkify>\n      </Comment.Content>\n    </Comment>\n  );\n};\n\nclass PickerMenuInner extends React.Component<{\n  addEmoji: (emoji: EmojiData) => void;\n  closeMenu: Function;\n}> {\n  handleClickOutside = () => {\n    this.props.closeMenu();\n  };\n  render() {\n    return (\n      <div style={{ position: 'absolute', bottom: '60px' }}>\n        <Picker\n          set=\"google\"\n          sheetSize={64}\n          theme=\"dark\"\n          showPreview={false}\n          showSkinTones={false}\n          onSelect={this.props.addEmoji}\n        />\n      </div>\n    );\n  }\n}\n\nconst PickerMenu = onClickOutside(PickerMenuInner);\n"]},"metadata":{},"sourceType":"module"}